name: Auto Deploy on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false
      
      - name: Get Runner IP
        id: ip
        run: echo "ip=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT
      
      - name: Create SSH Key if not exists
        run: |
          KEY_NAME="ollama-webui-key"
          if ! aws ec2 describe-key-pairs --key-names $KEY_NAME 2>/dev/null; then
            echo "Creating new key pair..."
            aws ec2 create-key-pair --key-name $KEY_NAME --query 'KeyMaterial' --output text > ollama-key.pem
            chmod 400 ollama-key.pem
          else
            echo "Key pair already exists"
          fi
      
      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          aws_region       = "${{ secrets.AWS_REGION || 'us-east-1' }}"
          instance_type    = "t3.xlarge"
          storage_size     = 50
          key_name         = "ollama-webui-key"
          allowed_ssh_cidr = "${{ steps.ip.outputs.ip }}/32"
          project_name     = "ollama-webui"
          EOF
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        run: terraform apply -auto-approve
      
      - name: Get Production URL
        id: url
        run: |
          PROD_URL=$(terraform output -raw webui_url)
          echo "url=${PROD_URL}" >> $GITHUB_OUTPUT
          echo "${PROD_URL}" > PRODUCTION-URL.txt
          
          echo "============================================================"
          echo ""
          echo "  ðŸŽ‰ DEPLOYMENT COMPLETE!"
          echo ""
          echo "  Production URL:"
          echo "  ${PROD_URL}"
          echo ""
          echo "============================================================"
          echo ""
          echo "â³ Installation in progress (5-10 minutes)"
          echo "ðŸ“ First user to register becomes admin"
          echo ""
      
      - name: Upload Production URL
        uses: actions/upload-artifact@v3
        with:
          name: production-url
          path: PRODUCTION-URL.txt
      
      - name: Comment PR with URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸŽ‰ **Deployment Complete!**\n\n**Production URL:** ${{ steps.url.outputs.url }}\n\nâ³ Wait 5-10 minutes for installation to complete.'
            })
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ steps.url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ **Status:** Installation in progress (5-10 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Note:** First user to register becomes admin" >> $GITHUB_STEP_SUMMARY
